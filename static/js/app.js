function activeMenuOption(href) {
    $(".app-menu .nav-link")
        .removeClass("active")
        .removeAttr('aria-current')

    $(`[href="${(href ? href : "#/")}"]`)
        .addClass("active")
        .attr("aria-current", "page")
}

const app = angular.module("angularjsApp", ["ngRoute"])
app.config(function($routeProvider, $locationProvider) {
    $locationProvider.hashPrefix("")

    $routeProvider
        .when("/", {
            templateUrl: "/app",
            controller: "appCtrl"
        })
        .when("/categorias", {
            templateUrl: "/categorias",
            controller: "categoriasCtrl"
        })
        .when("/lugares", {
            templateUrl: "/lugares",
            controller: "lugaresCtrl"
        })
        .when("/clientes", {
            templateUrl: "/clientes",
            controller: "clientesCtrl"
        })
        .when("/eventos", {
            templateUrl: "/eventos",
            controller: "eventosCtrl"
        })
        // Elimin√© la ruta de productos ya que no est√° definida en tus controladores
        .otherwise({
            redirectTo: "/"
        })
})
app.run(["$rootScope", "$location", "$timeout", function($rootScope, $location, $timeout) {
    function actualizarFechaHora() {
        lxFechaHora = DateTime
            .now()
            .setLocale("es")

        $rootScope.angularjsHora = lxFechaHora.toFormat("hh:mm:ss a")
        $timeout(actualizarFechaHora, 1000)
    }

    $rootScope.slide = ""

    actualizarFechaHora()

    $rootScope.$on("$routeChangeSuccess", function(event, current, previous) {
        $("html").css("overflow-x", "hidden")


        const path = current.$$route.originalPath

        if (path.indexOf("splash") == -1) {
            const active = $(".app-menu .nav-link.active").parent().index()
            const click = $(`[href^="#${path}"]`).parent().index()

            if (active != click) {
                $rootScope.slide = "animate__animated animate__faster animate__slideIn"
                $rootScope.slide += ((active > click) ? "Left" : "Right")
            }

            $timeout(function() {
                $("html").css("overflow-x", "auto")

                $rootScope.slide = ""
            }, 1000)

            activeMenuOption(`#${path}`)
        }
    })
}])

app.controller("appCtrl", function($scope, $http) {})


app.controller("eventosCtrl", function($scope, $http) {

    $scope.eventos = []

    // Obtener lista de categor√≠as
    $http.get("/eventos").then(function(res) {
        $scope.categorias = res.data
    })

    // Guardar evento
    $scope.guardar = function(eventos) {
        $http.post("/eventos/agregar", eventos).then(function(res) {
            console.log(res);
            console.log("evento guardado")
                // Recargar lista sin recargar toda la p√°gina
            $http.get("/eventos").then(function(res) {
                $scope.eventos = res.data
            })
            $scope.eventos = {} // Limpiar formulario
        }, function(err) {
            console.log("Error al guardar: " + (err.data ? err.message : ""));
        })
    }

    $scope.guardar = function(eventos) {
        $http.post("/eventos/eliminar", eventos).then(function(res) {
            console.log(res);
            console.log("evento eliminado")
                // Recargar lista sin recargar toda la p√°gina
            $http.get("/eventos").then(function(res) {
                $scope.eventos = res.data
            })
            $scope.eventos = {} // Limpiar formulario
        }, function(err) {
            console.log("Error al borrar: " + (err.data ? err.message : ""));
        })
    }


    // Obtener lista de eventos
    $http.get("/eventos").then(function(res) {
        $scope.eventos = res.data
    })

})


app.controller("categoriasCtrl", function($scope, $http) {
    $scope.categorias = [];
    $scope.mostrarTodos = true;

    // Configurar Pusher para tiempo real
    Pusher.logToConsole = true; // Activar logs para depuraci√≥n
    var pusher = new Pusher("db840e3e13b1c007269e", {
        cluster: 'us2',
        encrypted: true
    });

    // Suscribirse al canal de categor√≠as
    var channel = pusher.subscribe("canalCategorias");

    // Escuchar eventos de Pusher para actualizaciones en tiempo real
    channel.bind("categoria_guardada", function(data) {
        console.log('üì¶ Evento Pusher recibido: categoria_guardada', data);
        if ($scope.mostrarTodos) {
            $scope.allData(); // Recargar todos los datos
        }
        $scope.$applyAsync(); // Forzar actualizaci√≥n de Angular
    });

    channel.bind("categoria_eliminada", function(data) {
        console.log('üì¶ Evento Pusher recibido: categoria_eliminada', data);
        if ($scope.mostrarTodos) {
            $scope.allData(); // Recargar todos los datos
        }
        $scope.$applyAsync();
    });

    channel.bind("busqueda_realizada", function(data) {
        console.log('üì¶ Evento Pusher recibido: busqueda_realizada', data);
        // El backend podr√≠a notificar sobre b√∫squedas si es necesario
    });

    // Obtener todas las categor√≠as
    $scope.allData = function() {
        $http.get("/categorias/all").then(function(res) {
            $("#tablaCategorias").html(res.data);
            console.log('‚úÖ Datos cargados correctamente');
        }).catch(function(error) {
            console.error('‚ùå Error al cargar datos:', error);
            $("#tablaCategorias").html(`
                <tr>
                    <td colspan="4" class="text-center text-danger py-3">
                        <i class="fas fa-exclamation-triangle me-2"></i> 
                        Error al cargar categor√≠as
                    </td>
                </tr>
            `);
        });
    };

    // Inicializa el template
    $http.get("/categorias").then(function(res) {
        $scope.allData();
    });

    // Guardar categor√≠a - El backend publicar√° en Pusher autom√°ticamente
    $scope.guardar = function(categoria) {
        if (!categoria.nombreCategoria || !categoria.nombreCategoria.trim()) {
            alert("El nombre de la categor√≠a es requerido");
            return;
        }

        console.log('üíæ Guardando categor√≠a:', categoria);

        $http.post("/categorias/agregar", categoria)
            .then(function(response) {
                if (response.data.status === "success") {
                    $scope.categoria = {}; // Limpiar formulario
                    console.log('‚úÖ Categor√≠a guardada:', response.data);
                    alert("Categor√≠a guardada correctamente");

                    // El backend se encarga de publicar el evento Pusher
                    // para que todos los usuarios reciban la actualizaci√≥n

                } else {
                    alert("Error: " + response.data.message);
                }
            })
            .catch(function(error) {
                console.error("‚ùå Error al guardar:", error);
                if (error.data && error.data.message) {
                    alert("Error: " + error.data.message);
                } else {
                    alert("Error desconocido al guardar la categor√≠a");
                }
            });
    };

    // Buscar categor√≠as
    $scope.buscar = function(nombre) {
        console.log("üîç Buscando:", nombre);

        if (!nombre || nombre.trim() === '') {
            console.log("‚ÑπÔ∏è B√∫squeda vac√≠a, mostrando todos");
            $scope.mostrarTodos = true;
            $scope.allData();
            return;
        }

        $http.get("/categorias/buscar", {
                params: { busqueda: nombre }
            })
            .then(function(response) {
                $("#tablaCategorias").html(response.data);
                $scope.mostrarTodos = false;
                console.log('‚úÖ B√∫squeda completada');
            })
            .catch(function(error) {
                console.error("‚ùå Error en b√∫squeda:", error);

                let mensaje = "Error desconocido al buscar categor√≠as";
                if (error.data && error.data.message) {
                    mensaje = error.data.message;
                } else if (error.status === 500) {
                    mensaje = "Error interno del servidor";
                }

                $("#tablaCategorias").html(`
                    <tr>
                        <td colspan="4" class="text-center text-danger py-3">
                            <i class="fas fa-exclamation-triangle me-2"></i> 
                            ${mensaje}
                        </td>
                    </tr>
                `);

                alert("Error en b√∫squeda: " + mensaje);
            });
    };

    // Limpiar b√∫squeda
    $scope.limpiarBusqueda = function() {
        $scope.nombre = '';
        $scope.mostrarTodos = true;
        $scope.allData();
        console.log('üîÑ B√∫squeda limpiada');
    };

    // Limpiar suscripciones cuando el controlador se destruye
    $scope.$on('$destroy', function() {
        console.log('üßπ Limpiando suscripciones de Pusher');
        pusher.unsubscribe("canalCategorias");
    });
});


app.controller("clientesCtrl", function($scope, $http) {
    $scope.clientes = []
    $scope.searching = false;
    $scope.allData = function() {
            $http.get("/clientes/all").then(function(res) {
                $("#tablaClientes").html(res.data)
            })
        }
        //inizializa el template
    $http.get("/clientes").then(function(res) {
        $scope.allData()
    })
    Pusher.logToConsole = true
    var pusher = new Pusher("db840e3e13b1c007269e", {
        cluster: 'us2'
    })
    var channel = pusher.subscribe("canalClientes");
    channel.bind("newDataInserted", function(data) {
        if (!$scope.searching)
            $scope.allData();
    })

    $scope.buscar = function(nombre) {
            if (!nombre || nombre.trim() === '') {
                $scope.searching = false
                $scope.allData(); // Si la b√∫squeda est√° vac√≠a, mostrar todos
                return;
            }

            $http.get("/clientes/buscar", {
                params: {
                    busqueda: nombre
                }
            }).then(function(response) {
                console.log(response);

                $("#tablaClientes").html(response.data);
                $scope.searching = true;
            }, function(error) {
                console.error("Error en b√∫squeda:", error);
            })
        }
        // Guardar cliente
    $scope.guardar = function(cliente) {
        $http.post("/clientes/agregar", cliente).then(function() {
            $scope.cliente = {}
        }, function(err) {
            console.log("Error al guardar: " + (err.data ? err.message : ""))
        })
    }
})


app.controller("lugaresCtrl", function($scope, $http) {
    $scope.lugares = []

    $scope.allData = function() {
            $http.get("/lugares/all").then(function(res) {
                $("#tablaLugares").html(res.data)
            })
        }
        //inizializa el template
    $http.get("/").then(function(res) {
            $scope.allData()
            $http.get("/lugares/all").then(function(res) {
                $("#tablaLugares").html(res.data)
            })
        })
        //inizializa el template
    $http.get("/lugares").then(function(res) {
        $scope.allData()
    })

    Pusher.logToConsole = true

    var pusher = new Pusher("", {
        cluster: 'us2'
    })


    var channel = pusher.subscribe("");
    channel.bind("newDataInserted", function(data) {
        $scope.allData();
    })

    // Guardar lugar
    $scope.guardar = function(lugar) {
        $http.post("/lugar/guardar", lugar).then(function() {
            $scope.lugar = {}
            $scope.allData()
        }, function(err) {
            console.log("Error al guardar: " + (err.data ? err.message : ""))
        })
    }
})

const DateTime = luxon.DateTime
let lxFechaHora

document.addEventListener("DOMContentLoaded", function(event) {
    const configFechaHora = {
        locale: "es",
        weekNumbers: true,
        minuteIncrement: 15,
        altInput: true,
        altFormat: "d/F/Y",
        dateFormat: "Y-m-d",
    }

    activeMenuOption(location.hash)


})